<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - FusePDF Contact Submissions</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--card-background);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 2px solid var(--border-color);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .submissions-table {
            background: var(--card-background);
            border-radius: 1rem;
            border: 2px solid var(--border-color);
            overflow: hidden;
        }
        
        .table-header {
            background: var(--background-secondary);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .submission-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .submission-item:last-child {
            border-bottom: none;
        }
        
        .submission-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .submission-subject {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .submission-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .submission-details {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .submission-info {
            font-size: 0.9rem;
        }
        
        .submission-message {
            background: var(--background-secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .admin-actions {
            margin: 2rem 0;
            text-align: center;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .admin-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .admin-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .admin-btn.secondary {
            background: var(--background-secondary);
            color: var(--text-primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .submission-details {
                grid-template-columns: 1fr;
            }
            
            .admin-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="assets/images/logo.png" alt="FusePDF Logo" class="logo-img">
                <span class="logo-text">FusePDF</span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="privacy-policy.html" class="nav-link">Privacy</a>
                <a href="terms-of-service.html" class="nav-link">Terms</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">üåô</button>
            </nav>
        </div>
    </header>

    <!-- Privacy Banner -->
    <div class="privacy-banner">
        <div class="container">
            <p>üîí <strong>Admin Panel:</strong> Contact form submissions stored server-side. Enter token to load.</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <div class="admin-container">
            <div class="admin-header">
                <h1>üìß Contact Form Submissions</h1>
                <p>Review and manage contact form submissions stored securely in serverless KV storage</p>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSubmissions">0</div>
                    <div class="stat-label">Total Submissions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todaySubmissions">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="thisWeekSubmissions">0</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="storageUsed">0</div>
                    <div class="stat-label">Storage Used (KB)</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="admin-actions">
                <input type="password" id="adminToken" placeholder="Admin Token" style="padding:0.7rem 1rem;border:2px solid var(--border-color);border-radius:0.5rem;min-width:220px;" />
                <button class="admin-btn" onclick="refreshSubmissions()">üîÑ Load</button>
                <button class="admin-btn" onclick="exportSubmissions()">üì• Export JSON</button>
                <button class="admin-btn" onclick="exportCSV()">üìä Export CSV</button>
                <button class="admin-btn secondary" onclick="clearOldSubmissions()">üóëÔ∏è Clear Old (>30 days)</button>
                <button class="admin-btn secondary" onclick="clearAllSubmissions()" style="background: #dc2626;">‚ùå Clear All</button>
            </div>

            <!-- Submissions Table -->
            <div class="submissions-table">
                <div class="table-header">
                    <h3>Contact Submissions</h3>
                    <span id="submissionsCount">0 submissions</span>
                </div>
                <div id="submissionsList">
                    <!-- Submissions will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        // Admin Panel JavaScript
        let submissions = [];

        async function loadSubmissions() {
            const token = document.getElementById('adminToken').value.trim();
            if (!token) {
                submissions = [];
                renderSubmissions();
                updateStats();
                return;
            }
            try {
                const res = await fetch('/api/submissions', { headers: { 'X-Admin-Token': token } });
                if (!res.ok) throw new Error('Unauthorized or server error');
                const data = await res.json();
                submissions = data.submissions || [];
                renderSubmissions();
                updateStats();
                showMessage('Loaded submissions', 'success');
            } catch (err) {
                submissions = [];
                renderSubmissions();
                updateStats();
                showMessage(err.message, 'error');
            }
        }

        function renderSubmissions() {
            const container = document.getElementById('submissionsList');
            const countElement = document.getElementById('submissionsCount');
            
            countElement.textContent = `${submissions.length} submissions`;

            if (submissions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ No Submissions Yet</h3>
                        <p>Contact form submissions will appear here when users submit the form.</p>
                        <p><a href="contact.html">Go to Contact Form</a></p>
                    </div>
                `;
                return;
            }

            // Sort by newest first
            const sortedSubmissions = [...submissions].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            container.innerHTML = sortedSubmissions.map((submission, index) => `
                <div class="submission-item">
                    <div class="submission-meta">
                        <div class="submission-subject">
                            <strong>${submission.subject || 'No Subject'}</strong> - ${submission.name}
                        </div>
                        <div class="submission-date">
                            ${new Date(submission.timestamp).toLocaleString()}
                        </div>
                    </div>
                    <div class="submission-details">
                        <div class="submission-info">
                            <strong>Email:</strong> ${submission.email}<br>
                            <strong>Subject:</strong> ${submission.subject}<br>
                            <strong>Browser:</strong> ${submission.userAgent ? submission.userAgent.split(' ')[0] : 'Unknown'}<br>
                            <strong>URL:</strong> ${submission.url || 'Unknown'}
                        </div>
                        <div class="submission-message">
                            ${submission.message.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const total = submissions.length;
            document.getElementById('totalSubmissions').textContent = total;

            // Today's submissions
            const today = new Date().toDateString();
            const todayCount = submissions.filter(s => 
                new Date(s.timestamp).toDateString() === today
            ).length;
            document.getElementById('todaySubmissions').textContent = todayCount;

            // This week's submissions
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const weekCount = submissions.filter(s => 
                new Date(s.timestamp) >= weekAgo
            ).length;
            document.getElementById('thisWeekSubmissions').textContent = weekCount;

            // Storage used
            const dataSize = new Blob([JSON.stringify(submissions)]).size;
            document.getElementById('storageUsed').textContent = Math.round(dataSize / 1024);
        }

        function refreshSubmissions() {
            loadSubmissions();
            showMessage('Submissions refreshed', 'success');
        }

        function exportSubmissions() {
            if (submissions.length === 0) {
                showMessage('No submissions to export', 'info');
                return;
            }

            const dataStr = JSON.stringify(submissions, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `fusepdf_submissions_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage('JSON export downloaded', 'success');
        }

        function exportCSV() {
            if (submissions.length === 0) {
                showMessage('No submissions to export', 'info');
                return;
            }

            const headers = ['Timestamp', 'Name', 'Email', 'Subject', 'Message'];
            const csvContent = [
                headers.join(','),
                ...submissions.map(s => [
                    `"${s.timestamp}"`,
                    `"${s.name}"`,
                    `"${s.email}"`,
                    `"${s.subject}"`,
                    `"${s.message.replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `fusepdf_submissions_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage('CSV export downloaded', 'success');
        }

        async function clearOldSubmissions() {
            const token = document.getElementById('adminToken').value.trim();
            if (!token) { showMessage('Enter token first', 'error'); return; }
            if (!confirm('Clear submissions older than 30 days?')) return;
            try {
                const res = await fetch('/api/submissions-old?days=30', { method: 'DELETE', headers: { 'X-Admin-Token': token } });
                if (!res.ok) throw new Error('Failed to prune');
                const data = await res.json();
                await loadSubmissions();
                showMessage(`Removed ${data.removed} old submissions`, 'success');
            } catch (err) {
                showMessage(err.message, 'error');
            }
        }

        async function clearAllSubmissions() {
            const token = document.getElementById('adminToken').value.trim();
            if (!token) { showMessage('Enter token first', 'error'); return; }
            if (!confirm('Are you sure you want to delete ALL submissions? This cannot be undone!')) return;
            try {
                const res = await fetch('/api/submissions', { method: 'DELETE', headers: { 'X-Admin-Token': token } });
                if (!res.ok) throw new Error('Failed to clear');
                submissions = [];
                renderSubmissions();
                updateStats();
                showMessage('All submissions cleared', 'success');
            } catch (err) {
                showMessage(err.message, 'error');
            }
        }

        function showMessage(message, type = 'info') {
            // Create and show a temporary message
            const messageEl = document.createElement('div');
            messageEl.className = `form-status ${type}`;
            messageEl.textContent = message;
            messageEl.style.position = 'fixed';
            messageEl.style.top = '20px';
            messageEl.style.right = '20px';
            messageEl.style.zIndex = '1000';
            messageEl.style.minWidth = '200px';
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                document.body.removeChild(messageEl);
            }, 3000);
        }

        // Auto-refresh every 30 seconds
        // Manual refresh only to avoid hammering server
    </script>
</body>
</html>